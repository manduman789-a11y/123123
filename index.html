<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìš”ì¼ íˆ¬í‘œ Â· ì´ë¦„ë§Œ ê°€ì…</title>
  <meta name="description" content="ì´ë©”ì¼ ì—†ì´ ì´ë¦„ë§Œ ë“±ë¡í•´ì„œ ê¸°ëª… íˆ¬í‘œ (Supabase ì‚¬ìš©)" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b0f16;--card:#121826;--muted:#9aa5b1;--text:#e6edf3;--accent:#7c9cff;--accent2:#2dd4bf;--radius:16px;--ring:0 0 0 3px rgba(124,156,255,.25)}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 70% -20%, rgba(124,156,255,.12), transparent 60%),radial-gradient(1000px 600px at -10% 30%, rgba(45,212,191,.10), transparent 60%),var(--bg);color:var(--text);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple SD Gothic Neo','Noto Sans KR','Malgun Gothic', sans-serif;display:grid;place-items:center;padding:24px}
    .wrap{width:100%;max-width:820px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);backdrop-filter:blur(6px);box-shadow:0 10px 30px rgba(0,0,0,.45);overflow:hidden}
    header{padding:22px 22px 10px}
    .badge{display:inline-flex;align-items:center;gap:8px;color:var(--accent);font-size:12px;letter-spacing:.4px;background:rgba(124,156,255,.12);border:1px solid rgba(124,156,255,.35);padding:6px 10px;border-radius:999px}
    h1{margin:14px 0 10px;font-size:clamp(22px, 3.2vw, 28px);font-weight:700;line-height:1.25}
    .desc{margin:0 0 8px;color:var(--muted);font-size:14px}
    main{padding:18px 22px 22px}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    input[type=text]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.06);color:var(--text)}
    button{appearance:none;border:1px solid rgba(255,255,255,.18);background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));color:var(--text);padding:12px 16px;border-radius:12px;font-weight:700;letter-spacing:.2px;cursor:pointer}
    .btn-primary{background:linear-gradient(180deg, rgba(124,156,255,.7), rgba(124,156,255,.45));border-color:rgba(124,156,255,.55)}
    .option{display:flex;align-items:center;gap:12px;padding:12px 14px;margin-bottom:10px;border-radius:12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06)}
    input[type=checkbox]{appearance:none;-webkit-appearance:none;width:18px;height:18px;border:2px solid rgba(255,255,255,.5);border-radius:5px;display:grid;place-content:center;outline:none}
    input[type=checkbox]:checked{border-color:var(--accent);box-shadow:var(--ring);background:var(--accent)}
    .results{display:grid;gap:10px;margin-top:16px}
    .bar{position:relative;height:36px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .bar-fill{position:absolute;inset:0;width:0%;background:linear-gradient(90deg, rgba(124,156,255,.9), rgba(45,212,191,.9));transition:width .6s ease}
    .bar-label{position:relative;z-index:1;height:100%;display:flex;justify-content:space-between;align-items:center;padding:0 12px;font-weight:600;font-size:14px}
    .list{margin:6px 0 0 0;color:var(--muted);font-size:13px}
    .footer{padding:12px 22px 22px;display:flex;justify-content:space-between;align-items:center}
    a.link{color:var(--accent2);text-decoration:none;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="badge">ğŸ—³ï¸ ì´ë¦„ë§Œ ë“±ë¡ Â· ê¸°ëª… íˆ¬í‘œ</span>
      <h1>ì´ë²ˆ ì£¼ ê°€ëŠ¥í•œ ìš”ì¼ì„ ì„ íƒí•˜ì„¸ìš”</h1>
      <p class="desc">ì´ë¦„ë§Œ ì…ë ¥í•˜ì—¬ ê°€ì… í›„ íˆ¬í‘œí•©ë‹ˆë‹¤. 1ëª…ë‹¹ 1íšŒ ì œì¶œ(ì—¬ëŸ¬ ìš”ì¼ ì„ íƒ ê°€ëŠ¥), ì œì¶œ í›„ì—ëŠ” ë‹¤ì‹œ ì„ íƒí•˜ì—¬ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    </header>
    <main>
      <!-- ì´ë¦„ ê°€ì… ì¹´ë“œ -->
      <section class="card" id="signup-card" hidden>
        <div class="row" style="align-items:flex-end">
          <div class="col">
            <label for="name" class="desc">ì´ë¦„(ë‹‰ë„¤ì„)</label>
            <input type="text" id="name" placeholder="ì˜ˆ: ë¯¼ìš°" />
          </div>
          <div>
            <button id="signup" class="btn-primary">ì´ë¦„ìœ¼ë¡œ ê°€ì…</button>
          </div>
        </div>
        <p class="desc" style="margin-top:8px">ì´ë©”ì¼ ì—†ì´ ë¡œì»¬ ê¸°ê¸° ê¸°ì¤€ìœ¼ë¡œ ê°€ì…ë©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ë¥¼ ë°”ê¾¸ë©´ ìƒˆë¡œ ê°€ì…í•´ì•¼ í•©ë‹ˆë‹¤.</p>
      </section>

      <!-- í”„ë¡œí•„ ì¹´ë“œ -->
      <section class="card" id="profile-card" hidden>
        <div class="row" style="align-items:flex-end">
          <div class="col">
            <label class="desc">ë‚´ ì´ë¦„</label>
            <input type="text" id="myname" />
          </div>
          <div>
            <button id="save-name" class="btn-primary">ì €ì¥</button>
          </div>
          <div style="margin-left:auto">
            <button id="logout">ë¡œê·¸ì•„ì›ƒ(ì´ ê¸°ê¸°ì—ì„œ í•´ì œ)</button>
          </div>
        </div>
      </section>

      <!-- íˆ¬í‘œ ì¹´ë“œ -->
      <section class="card" id="vote-card" hidden>
        <form id="vote-form">
          <div id="options"></div>
          <div class="row" style="margin-top:12px;gap:10px">
            <button type="submit" class="btn-primary">íˆ¬í‘œí•˜ê¸° / ë‹¤ì‹œ ì„ íƒ</button>
            <button type="button" id="refresh">ê²°ê³¼ ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </form>
        <div class="results" id="results"></div>
        <p class="desc" id="meta"></p>
      </section>
    </main>
    <div class="footer">
      <a class="link" href="http://googooduck.kro.kr/">googooduck.kro.kr</a>
      <span class="desc">Supabase Â· ì´ë©”ì¼ ì—†ì´ ì´ë¦„ë§Œ ê°€ì…</span>
    </div>
  </div>

<script>
/**************** ì„¤ì • ****************/
const SUPABASE_URL = 'https://ahtrczqyoakxrlgqgqom.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFodHJjenF5b2FreHJsZ3FncW9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDc5NzEsImV4cCI6MjA3ODMyMzk3MX0.3oMNLnUK9-N52Mmb5-264sk7RXSqaFHg2jQMggLWhsQ';               // TODO êµì²´
const POLL_ID = 'weekday-2025-11-10';
const OPTIONS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/**************** ë¡œì»¬ ì„¸ì…˜ ****************/
const LS_USER_ID = 'namedvote.user_id';
const LS_CLIENT_ID = 'namedvote.client_id';
function getClientId(){ let id = localStorage.getItem(LS_CLIENT_ID); if(!id){ id = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)); localStorage.setItem(LS_CLIENT_ID, id);} return id; }
function getUserId(){ return localStorage.getItem(LS_USER_ID); }
function setUserId(id){ localStorage.setItem(LS_USER_ID, id); }
function clearLocal(){ localStorage.removeItem(LS_USER_ID); }

/**************** DOM í—¬í¼ ****************/
const $ = (s)=>document.querySelector(s);
function show(id, on=true){ const el = $(id); if(el) el.hidden = !on; }

/**************** ì´ˆê¸° UI ****************/
async function boot(){
  const userId = getUserId();
  if(!userId){ show('#signup-card', true); show('#profile-card', false); show('#vote-card', false); }
  else {
    // í”„ë¡œí•„ ë¡œë“œ
    const { data, error } = await sb.from('users').select('id, name').eq('id', userId).maybeSingle();
    if(error || !data){ clearLocal(); return boot(); }
    $('#myname').value = data.name;
    show('#signup-card', false); show('#profile-card', true); show('#vote-card', true);
    initVoteUI();
  }
}

/**************** ê°€ì…/í”„ë¡œí•„ ****************/
$('#signup').addEventListener('click', async ()=>{
  const name = $('#name').value.trim(); if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const clientId = getClientId();
  // ê°™ì€ ê¸°ê¸°ì—ì„œ ì¤‘ë³µ ê°€ì… ë°©ì§€(ì•± ë¡œì§)
  const { data: exist } = await sb.from('users').select('id').eq('client_id', clientId).limit(1);
  if(exist && exist.length){ alert('ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
  const { data, error } = await sb.from('users').insert({ name, client_id: clientId }).select('id').maybeSingle();
  if(error) return alert('ê°€ì… ì˜¤ë¥˜: '+error.message);
  setUserId(data.id);
  await boot();
});

$('#save-name').addEventListener('click', async ()=>{
  const id = getUserId(); if(!id) return;
  const name = $('#myname').value.trim(); if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const { error } = await sb.from('users').update({ name }).eq('id', id);
  if(error) return alert('ì €ì¥ ì˜¤ë¥˜: '+error.message);
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  await renderResults();
});

$('#logout').addEventListener('click', async ()=>{ clearLocal(); location.reload(); });

/**************** íˆ¬í‘œ UI/ë¡œì§ ****************/
function initVoteUI(){
  const optionsWrap = $('#options'); optionsWrap.innerHTML='';
  OPTIONS.forEach((label, idx)=>{
    const id = `opt-${idx}`;
    const row = document.createElement('label'); row.className='option'; row.setAttribute('for', id);
    row.innerHTML = `<input type="checkbox" id="${id}" value="${idx}" /><span>${label}</span>`;
    optionsWrap.appendChild(row);
  });
  $('#vote-form').addEventListener('submit', onSubmit, { once:true });
  $('#refresh').addEventListener('click', renderResults);
  preloadMyChoices();
  renderResults();
}

async function preloadMyChoices(){
  const uid = getUserId(); if(!uid) return;
  const { data, error } = await sb.from('votes').select('option_index').eq('poll_id', POLL_ID).eq('user_id', uid);
  if(error) return;
  const set = new Set((data||[]).map(r=>r.option_index));
  OPTIONS.forEach((_, idx)=>{ const el = document.getElementById(`opt-${idx}`); if(el) el.checked = set.has(idx); });
}

async function onSubmit(e){
  e.preventDefault();
  const selected = Array.from(document.querySelectorAll('#options input[type=checkbox]:checked')).map(el=>Number(el.value));
  if(!selected.length){ alert('ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.'); $('#vote-form').addEventListener('submit', onSubmit, { once:true }); return; }
  const uid = getUserId(); if(!uid) return alert('ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  // ê¸°ì¡´ í‘œ ì‚­ì œ í›„ ì¬ì‚½ì…
  let { error: e1 } = await sb.from('votes').delete().eq('poll_id', POLL_ID).eq('user_id', uid);
  if(e1){ alert('ì´ˆê¸°í™” ì˜¤ë¥˜: '+e1.message); $('#vote-form').addEventListener('submit', onSubmit, { once:true }); return; }
  const rows = selected.map(i=>({ poll_id: POLL_ID, option_index: i, user_id: uid }));
  let { error: e2 } = await sb.from('votes').insert(rows);
  if(e2){ alert('ì €ì¥ ì˜¤ë¥˜: '+e2.message); $('#vote-form').addEventListener('submit', onSubmit, { once:true }); return; }
  alert('ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
  await renderResults();
  $('#vote-form').addEventListener('submit', onSubmit, { once:true });
}

async function renderResults(){
  const uid = getUserId();
  const [agg, named] = await Promise.all([
    sb.from('votes_agg').select('option_index, count').eq('poll_id', POLL_ID),
    sb.from('votes_named').select('option_index, name, user_id').eq('poll_id', POLL_ID)
  ]);
  const counts = Array(OPTIONS.length).fill(0);
  if(agg.data){ for(const r of agg.data){ if(r.option_index>=0 && r.option_index<counts.length) counts[r.option_index]=r.count; } }
  const total = counts.reduce((a,b)=>a+b,0);

  const byOpt = Array.from({length:OPTIONS.length},()=>[]);
  if(named.data){ for(const r of named.data){ if(r.option_index>=0&&r.option_index<byOpt.length) byOpt[r.option_index].push({name:r.name, me:r.user_id===uid}); } }

  const resultsWrap = $('#results'); resultsWrap.innerHTML='';
  OPTIONS.forEach((label, idx)=>{
    const count = counts[idx]; const pct = total? Math.round(count/total*100):0;
    const div = document.createElement('div'); div.className='bar';
    div.innerHTML = `<div class="bar-fill" style="width:${pct}%"></div><div class="bar-label"><span>${label}</span><span>${pct}% (${count}í‘œ)</span></div>`;
    resultsWrap.appendChild(div);
    const ul = document.createElement('div'); ul.className='list';
    const names = byOpt[idx].map(p=> p.me? `ğŸŒŸ ${p.name}` : p.name);
    ul.textContent = names.length? names.join(', ') : 'â€”';
    resultsWrap.appendChild(ul);
  });
  $('#meta').textContent = `ì´ ${total}í‘œ Â· ì´ë¦„ ê³µê°œ ê¸°ëª… íˆ¬í‘œ`;
}

boot();
</script>

<!--
======================
í•„ìˆ˜ SQL (Supabase SQL Editorì—ì„œ ì‹¤í–‰)
======================

-- 0) í™•ì¥ (uuid ìƒì„±)
create extension if not exists pgcrypto;

-- 1) ì‚¬ìš©ì(ì´ë¦„ ê¸°ë°˜) í…Œì´ë¸”
create table if not exists public.users (
  id uuid primary key default gen_random_uuid(),
  name text not null check (length(name) > 0),
  client_id text not null unique, -- ë¸Œë¼ìš°ì € ë‹¨ìœ„ ì¤‘ë³µ ê°€ì… ë°©ì§€ìš©(ì•± ë¡œì§ ë³´ì¡°)
  created_at timestamptz default now()
);

-- 2) íˆ¬í‘œ í…Œì´ë¸” (ê¸°ëª…)
create table if not exists public.votes (
  id bigint generated by default as identity primary key,
  poll_id text not null,
  option_index int not null check (option_index >= 0),
  user_id uuid not null references public.users(id) on delete cascade,
  created_at timestamptz default now(),
  unique (poll_id, user_id, option_index)
);

-- 3) ë·° (ì§‘ê³„/ê¸°ëª…)
create or replace view public.votes_agg as
select poll_id, option_index, count(*)::int as count
from public.votes
group by poll_id, option_index;

grant select on public.votes_agg to anon;  -- ëˆ„êµ¬ë‚˜ ì§‘ê³„ ì¡°íšŒ

create or replace view public.votes_named as
select v.poll_id, v.option_index, u.name, v.user_id
from public.votes v
join public.users u on u.id = v.user_id;

grant select on public.votes_named to anon; -- ëˆ„êµ¬ë‚˜ ê¸°ëª… ëª©ë¡ ì¡°íšŒ

-- 4) RLS (ì„ íƒ: ë‹¨ìˆœ ê³µê°œ ì„œë¹„ìŠ¤ë©´ ë¹„í™œì„±ë¡œ ë‘ì–´ë„ ë¨)
-- ì•„ë˜ëŠ” RLSë¥¼ í™œì„±í™”í•˜ê³ , ìµëª…ì—ê²Œë„ ëª¨ë‘ í—ˆìš©í•˜ëŠ” ìµœì†Œ ì •ì±…ì…ë‹ˆë‹¤.
-- í•„ìš” ì‹œ ip/í† í° ì»¬ëŸ¼ ì¶”ê°€í•˜ì—¬ ê°•í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

alter table public.users enable row level security;
alter table public.votes enable row level security;

drop policy if exists "users read" on public.users;
create policy "users read" on public.users for select to anon using (true);

drop policy if exists "users write" on public.users;
create policy "users write" on public.users for insert to anon with check (true);

-- ì´ë¦„ ë³€ê²½ í—ˆìš©(ëª¨ë‘)
drop policy if exists "users update" on public.users;
create policy "users update" on public.users for update to anon using (true) with check (true);

-- votes

drop policy if exists "votes read" on public.votes;
create policy "votes read" on public.votes for select to anon using (true);

drop policy if exists "votes write" on public.votes;
create policy "votes write" on public.votes for insert to anon with check (true);

-- ìˆ˜ì •/ì‚­ì œë„ í—ˆìš©(ê°„ë‹¨ ì„œë¹„ìŠ¤ìš©)
drop policy if exists "votes update" on public.votes;
create policy "votes update" on public.votes for update to anon using (true) with check (true);

drop policy if exists "votes delete" on public.votes;
create policy "votes delete" on public.votes for delete to anon using (true);

-- (ì„ íƒ) íŠ¹ì • poll ì´ˆê¸°í™”: delete from public.votes where poll_id = 'weekday-2025-11-10';
-- (ì„ íƒ) ì‚¬ìš©ì ëª©ë¡: select * from public.users order by created_at desc;
-->

</body>
</html>
