<script>
/**************** ì„¤ì • ****************/
const SUPABASE_URL = 'https://ahtrczqyoakxrlgqgqom.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFodHJjenF5b2FreHJsZ3FncW9tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NDc5NzEsImV4cCI6MjA3ODMyMzk3MX0.3oMNLnUK9-N52Mmb5-264sk7RXSqaFHg2jQMggLWhsQ'; Â  Â  Â  Â  Â  Â  Â  
let CURRENT_POLL_ID = null; // ğŸ‘ˆ ìƒˆë¡œ ì¶”ê°€: ë™ì  íˆ¬í‘œ IDë¥¼ ì €ì¥í•  ë³€ìˆ˜ (í•˜ë“œì½”ë”©ëœ POLL_ID ëŒ€ì²´)
const OPTIONS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];

const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/**************** ë¡œì»¬ ì„¸ì…˜ ****************/
const LS_USER_ID = 'namedvote.user_id';
const LS_CLIENT_ID = 'namedvote.client_id';
function getClientId(){ let id = localStorage.getItem(LS_CLIENT_ID); if(!id){ id = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)); localStorage.setItem(LS_CLIENT_ID, id);} return id; }
function getUserId(){ return localStorage.getItem(LS_USER_ID); }
function setUserId(id){ localStorage.setItem(LS_USER_ID, id); }
function clearLocal(){ localStorage.removeItem(LS_USER_ID); }

/**************** DOM í—¬í¼ ****************/
const $ = (s)=>document.querySelector(s);
function show(id, on=true){ const el = $(id); if(el) el.hidden = !on; }

/**************** ì´ˆê¸° UI ****************/
async function boot(){
  // 1. íˆ¬í‘œ ë©”íƒ€ ë°ì´í„° (í˜„ì¬ íˆ¬í‘œ ID)ë¥¼ ë¨¼ì € ê°€ì ¸ì˜µë‹ˆë‹¤. ğŸ‘ˆ ì¤‘ìš” ìˆ˜ì • ë¶€ë¶„
  const { data: meta, error: metaError } = await sb.from('poll_meta').select('current_poll_id').eq('id', 1).maybeSingle();
  if(metaError || !meta){
      console.error('íˆ¬í‘œ ë©”íƒ€ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜: ', metaError);
      alert('íˆ¬í‘œ ë©”íƒ€ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜. Supabase ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.');
      return;
  }
  CURRENT_POLL_ID = meta.current_poll_id; // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
  
  // 2. ì´í›„ ê¸°ì¡´ ë¡œê·¸ì¸ ë¡œì§ ì‹¤í–‰
  const userId = getUserId();
  if(!userId){ show('#signup-card', true); show('#profile-card', false); show('#vote-card', false); }
  else {
    // í”„ë¡œí•„ ë¡œë“œ
    const { data, error } = await sb.from('users').select('id, name').eq('id', userId).maybeSingle();
    if(error || !data){ clearLocal(); return boot(); }
    $('#myname').value = data.name;
    show('#signup-card', false); show('#profile-card', true); show('#vote-card', true);
    initVoteUI();
  }
}

/**************** ê°€ì…/í”„ë¡œí•„ ****************/
$('#signup').addEventListener('click', async ()=>{
  const name = $('#name').value.trim(); if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const clientId = getClientId();
  // ê°™ì€ ê¸°ê¸°ì—ì„œ ì¤‘ë³µ ê°€ì… ë°©ì§€(ì•± ë¡œì§)
  const { data: exist } = await sb.from('users').select('id').eq('client_id', clientId).limit(1);
  if(exist && exist.length){ alert('ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ ê°€ì…ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
  const { data, error } = await sb.from('users').insert({ name, client_id: clientId }).select('id').maybeSingle();
  if(error) return alert('ê°€ì… ì˜¤ë¥˜: '+error.message);
  setUserId(data.id);
  await boot();
});

$('#save-name').addEventListener('click', async ()=>{
  const id = getUserId(); if(!id) return;
  const name = $('#myname').value.trim(); if(!name) return alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
  const { error } = await sb.from('users').update({ name }).eq('id', id);
  if(error) return alert('ì €ì¥ ì˜¤ë¥˜: '+error.message);
  alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
  await renderResults();
});

$('#logout').addEventListener('click', async ()=>{ clearLocal(); location.reload(); });

/**************** íˆ¬í‘œ UI/ë¡œì§ ****************/
function initVoteUI(){
  const optionsWrap = $('#options'); optionsWrap.innerHTML='';
  OPTIONS.forEach((label, idx)=>{
    const id = `opt-${idx}`;
    const row = document.createElement('label'); row.className='option'; row.setAttribute('for', id);
    row.innerHTML = `<input type="checkbox" id="${id}" value="${idx}" /><span>${label}</span>`;
    optionsWrap.appendChild(row);
  });
  $('#vote-form').addEventListener('submit', onSubmit, { once:true });
  $('#refresh').addEventListener('click', renderResults);
  preloadMyChoices();
  renderResults();
}

async function preloadMyChoices(){
  const uid = getUserId(); if(!uid) return;
  // ğŸš¨ POLL_ID -> CURRENT_POLL_ID ìˆ˜ì •
  const { data, error } = await sb.from('votes').select('option_index').eq('poll_id', CURRENT_POLL_ID).eq('user_id', uid);
  if(error) return;
  const set = new Set((data||[]).map(r=>r.option_index));
  OPTIONS.forEach((_, idx)=>{ const el = document.getElementById(`opt-${idx}`); if(el) el.checked = set.has(idx); });
}

async function onSubmit(e){
  e.preventDefault();
  const selected = Array.from(document.querySelectorAll('#options input[type=checkbox]:checked')).map(el=>Number(el.value));
  if(!selected.length){ alert('ìµœì†Œ 1ê°œ ì´ìƒ ì„ íƒí•˜ì„¸ìš”.'); $('#vote-form').addEventListener('submit', onSubmit, { once:true }); return; }
  const uid = getUserId(); if(!uid) return alert('ê°€ì…ì´ í•„ìš”í•©ë‹ˆë‹¤.');
  // ê¸°ì¡´ í‘œ ì‚­ì œ í›„ ì¬ì‚½ì… (ğŸš¨ POLL_ID -> CURRENT_POLL_ID ìˆ˜ì •)
  let { error: e1 } = await sb.from('votes').delete().eq('poll_id', CURRENT_POLL_ID).eq('user_id', uid);
  if(e1){ alert('ì´ˆê¸°í™” ì˜¤ë¥˜: '+e1.message); $('#vote-form').addEventListener('submit', onSubmit, { once:true }); return; }
  // ğŸš¨ POLL_ID -> CURRENT_POLL_ID ìˆ˜ì •
  const rows = selected.map(i=>({ poll_id: CURRENT_POLL_ID, option_index: i, user_id: uid }));
  let { error: e2 } = await sb.from('votes').insert(rows);
  if(e2){ alert('ì €ì¥ ì˜¤ë¥˜: '+e2.message); $('#vote-form').addEventListener('submit', onSubmit, { once:true }); return; }
  alert('ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.');
  await renderResults();
  $('#vote-form').addEventListener('submit', onSubmit, { once:true });
}

async function renderResults(){
  const uid = getUserId();
  const [agg, named] = await Promise.all([
    // ğŸš¨ POLL_ID -> CURRENT_POLL_ID ìˆ˜ì •
    sb.from('votes_agg').select('option_index, count').eq('poll_id', CURRENT_POLL_ID),
    // ğŸš¨ POLL_ID -> CURRENT_POLL_ID ìˆ˜ì •
    sb.from('votes_named').select('option_index, name, user_id').eq('poll_id', CURRENT_POLL_ID)
  ]);
  const counts = Array(OPTIONS.length).fill(0);
  if(agg.data){ for(const r of agg.data){ if(r.option_index>=0 && r.option_index<counts.length) counts[r.option_index]=r.count; } }
  const total = counts.reduce((a,b)=>a+b,0);

  const byOpt = Array.from({length:OPTIONS.length},()=>[]);
  if(named.data){ for(const r of named.data){ if(r.option_index>=0&&r.option_index<byOpt.length) byOpt[r.option_index].push({name:r.name, me:r.user_id===uid}); } }

  const resultsWrap = $('#results'); resultsWrap.innerHTML='';
  OPTIONS.forEach((label, idx)=>{
    const count = counts[idx]; const pct = total? Math.round(count/total*100):0;
    const div = document.createElement('div'); div.className='bar';
    div.innerHTML = `<div class="bar-fill" style="width:${pct}%"></div><div class="bar-label"><span>${label}</span><span>${pct}% (${count}í‘œ)</span></div>`;
    resultsWrap.appendChild(div);
    const ul = document.createElement('div'); ul.className='list';
    const names = byOpt[idx].map(p=> p.me? `ğŸŒŸ ${p.name}` : p.name);
    ul.textContent = names.length? names.join(', ') : 'â€”';
    resultsWrap.appendChild(ul);
  });
  $('#meta').textContent = `ì´ ${total}í‘œ Â· ì´ë¦„ ê³µê°œ ê¸°ëª… íˆ¬í‘œ`;
}

boot();
</script>